"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const debug_1 = __importDefault(require("debug"));
const html_webpack_plugin_1 = __importDefault(require("html-webpack-plugin"));
const webpack_1 = __importDefault(require("webpack"));
const webpack_merge_1 = require("webpack-merge");
const AssetRelocatorPatch_1 = __importDefault(require("./util/AssetRelocatorPatch"));
const processConfig_1 = __importDefault(require("./util/processConfig"));
const rendererTypeUtils_1 = require("./util/rendererTypeUtils");
const d = (0, debug_1.default)('electron-forge:plugin:webpack:webpackconfig');
var RendererTarget;
(function (RendererTarget) {
    RendererTarget[RendererTarget["Web"] = 0] = "Web";
    RendererTarget[RendererTarget["ElectronRenderer"] = 1] = "ElectronRenderer";
    RendererTarget[RendererTarget["ElectronPreload"] = 2] = "ElectronPreload";
    RendererTarget[RendererTarget["SandboxedPreload"] = 3] = "SandboxedPreload";
})(RendererTarget || (RendererTarget = {}));
var WebpackTarget;
(function (WebpackTarget) {
    WebpackTarget["Web"] = "web";
    WebpackTarget["ElectronPreload"] = "electron-preload";
    WebpackTarget["ElectronRenderer"] = "electron-renderer";
})(WebpackTarget || (WebpackTarget = {}));
function isNotNull(item) {
    return item !== null;
}
function rendererTargetToWebpackTarget(target) {
    switch (target) {
        case RendererTarget.Web:
        case RendererTarget.SandboxedPreload:
            return WebpackTarget.Web;
        case RendererTarget.ElectronPreload:
            return WebpackTarget.ElectronPreload;
        case RendererTarget.ElectronRenderer:
            return WebpackTarget.ElectronRenderer;
    }
}
class WebpackConfigGenerator {
    constructor(pluginConfig, projectDir, isProd, port) {
        // Users can override this method in a subclass to provide custom logic or
        // configuration parameters.
        this.preprocessConfig = async (config) => config({}, {
            mode: this.mode,
        });
        this.pluginConfig = pluginConfig;
        this.projectDir = projectDir;
        this.webpackDir = path_1.default.resolve(projectDir, '.webpack');
        this.isProd = isProd;
        this.port = port;
        d('Config mode:', this.mode);
    }
    async resolveConfig(config) {
        const rawConfig = typeof config === 'string'
            ? // eslint-disable-next-line @typescript-eslint/no-var-requires
                require(path_1.default.resolve(this.projectDir, config))
            : config;
        return (0, processConfig_1.default)(this.preprocessConfig, rawConfig);
    }
    get mode() {
        return this.isProd ? 'production' : 'development';
    }
    get rendererSourceMapOption() {
        return this.isProd ? 'source-map' : 'eval-source-map';
    }
    rendererEntryPoint(entryPoint, inRendererDir, basename) {
        if (this.isProd) {
            return `\`file://$\{require('path').resolve(__dirname, '..', '${inRendererDir ? 'renderer' : '.'}', '${entryPoint.name}', '${basename}')}\``;
        }
        const baseUrl = `http://localhost:${this.port}/${entryPoint.name}`;
        if (basename !== 'index.html') {
            return `'${baseUrl}/${basename}'`;
        }
        return `'${baseUrl}'`;
    }
    toEnvironmentVariable(entryPoint, preload = false) {
        const suffix = preload ? '_PRELOAD_WEBPACK_ENTRY' : '_WEBPACK_ENTRY';
        return `${entryPoint.name.toUpperCase().replace(/ /g, '_')}${suffix}`;
    }
    getPreloadDefine(entryPoint) {
        if (!(0, rendererTypeUtils_1.isNoWindow)(entryPoint)) {
            if (this.isProd) {
                return `require('path').resolve(__dirname, '../renderer', '${entryPoint.name}', 'preload.js')`;
            }
            return `'${path_1.default.resolve(this.webpackDir, 'renderer', entryPoint.name, 'preload.js').replace(/\\/g, '\\\\')}'`;
        }
        else {
            // If this entry-point has no configured preload script just map this constant to `undefined`
            // so that any code using it still works.  This makes quick-start / docs simpler.
            return 'undefined';
        }
    }
    getDefines(inRendererDir = true) {
        const defines = {};
        if (!this.pluginConfig.renderer.entryPoints || !Array.isArray(this.pluginConfig.renderer.entryPoints)) {
            throw new Error('Required config option "renderer.entryPoints" has not been defined');
        }
        for (const entryPoint of this.pluginConfig.renderer.entryPoints) {
            const entryKey = this.toEnvironmentVariable(entryPoint);
            if ((0, rendererTypeUtils_1.isLocalWindow)(entryPoint)) {
                defines[entryKey] = this.rendererEntryPoint(entryPoint, inRendererDir, 'index.html');
            }
            else {
                defines[entryKey] = this.rendererEntryPoint(entryPoint, inRendererDir, 'index.js');
            }
            defines[`process.env.${entryKey}`] = defines[entryKey];
            const preloadDefineKey = this.toEnvironmentVariable(entryPoint, true);
            defines[preloadDefineKey] = this.getPreloadDefine(entryPoint);
            defines[`process.env.${preloadDefineKey}`] = defines[preloadDefineKey];
        }
        return defines;
    }
    async getMainConfig() {
        const mainConfig = await this.resolveConfig(this.pluginConfig.mainConfig);
        if (!mainConfig.entry) {
            throw new Error('Required option "mainConfig.entry" has not been defined');
        }
        const fix = (item) => {
            if (typeof item === 'string')
                return fix([item])[0];
            if (Array.isArray(item)) {
                return item.map((val) => (val.startsWith('./') ? path_1.default.resolve(this.projectDir, val) : val));
            }
            const ret = {};
            for (const key of Object.keys(item)) {
                ret[key] = fix(item[key]);
            }
            return ret;
        };
        mainConfig.entry = fix(mainConfig.entry);
        return (0, webpack_merge_1.merge)({
            devtool: 'source-map',
            target: 'electron-main',
            mode: this.mode,
            output: {
                path: path_1.default.resolve(this.webpackDir, 'main'),
                filename: 'index.js',
                libraryTarget: 'commonjs2',
            },
            plugins: [new webpack_1.default.DefinePlugin(this.getDefines())],
            node: {
                __dirname: false,
                __filename: false,
            },
        }, mainConfig || {});
    }
    async getRendererConfig(entryPoints) {
        var _a, _b;
        const entryPointsForTarget = {
            web: [],
            electronRenderer: [],
            electronPreload: [],
            sandboxedPreload: [],
        };
        for (const entry of entryPoints) {
            const target = ((_a = entry.nodeIntegration) !== null && _a !== void 0 ? _a : this.pluginConfig.renderer.nodeIntegration) ? 'electronRenderer' : 'web';
            const preloadTarget = ((_b = entry.nodeIntegration) !== null && _b !== void 0 ? _b : this.pluginConfig.renderer.nodeIntegration) ? 'electronPreload' : 'sandboxedPreload';
            if ((0, rendererTypeUtils_1.isPreloadOnly)(entry)) {
                entryPointsForTarget[preloadTarget].push(entry);
            }
            else {
                entryPointsForTarget[target].push(entry);
                if ((0, rendererTypeUtils_1.isLocalWindow)(entry) && entry.preload) {
                    entryPointsForTarget[preloadTarget].push({ ...entry, preload: entry.preload });
                }
            }
        }
        const rendererConfigs = await Promise.all([
            await this.buildRendererConfigs(entryPointsForTarget.web, RendererTarget.Web),
            await this.buildRendererConfigs(entryPointsForTarget.electronRenderer, RendererTarget.ElectronRenderer),
            await this.buildRendererConfigs(entryPointsForTarget.electronPreload, RendererTarget.ElectronPreload),
            await this.buildRendererConfigs(entryPointsForTarget.sandboxedPreload, RendererTarget.SandboxedPreload),
        ].reduce((configs, allConfigs) => allConfigs.concat(configs)));
        return rendererConfigs.filter(isNotNull);
    }
    buildRendererBaseConfig(target) {
        return {
            target: rendererTargetToWebpackTarget(target),
            devtool: this.rendererSourceMapOption,
            mode: this.mode,
            output: {
                path: path_1.default.resolve(this.webpackDir, 'renderer'),
                filename: '[name]/index.js',
                globalObject: 'self',
                ...(this.isProd ? {} : { publicPath: '/' }),
            },
            node: {
                __dirname: false,
                __filename: false,
            },
            plugins: [new AssetRelocatorPatch_1.default(this.isProd, target === RendererTarget.ElectronRenderer || target === RendererTarget.ElectronPreload)],
        };
    }
    async buildRendererConfigForWebOrRendererTarget(entryPoints, target) {
        if (!(0, rendererTypeUtils_1.isLocalOrNoWindowEntries)(entryPoints)) {
            throw new Error('Invalid renderer entry point detected.');
        }
        const entry = {};
        const baseConfig = this.buildRendererBaseConfig(target);
        const rendererConfig = await this.resolveConfig(this.pluginConfig.renderer.config);
        const output = {
            path: path_1.default.resolve(this.webpackDir, 'renderer'),
            filename: '[name]/index.js',
            globalObject: 'self',
            ...(this.isProd ? {} : { publicPath: '/' }),
        };
        const plugins = [];
        for (const entryPoint of entryPoints) {
            entry[entryPoint.name] = (entryPoint.prefixedEntries || []).concat([entryPoint.js]);
            if ((0, rendererTypeUtils_1.isLocalWindow)(entryPoint)) {
                plugins.push(new html_webpack_plugin_1.default({
                    title: entryPoint.name,
                    template: entryPoint.html,
                    filename: `${entryPoint.name}/index.html`,
                    chunks: [entryPoint.name].concat(entryPoint.additionalChunks || []),
                }));
            }
        }
        return (0, webpack_merge_1.merge)(baseConfig, rendererConfig || {}, { entry, output, plugins });
    }
    async buildRendererConfigForPreloadOrSandboxedPreloadTarget(entryPoints, target) {
        var _a;
        if (entryPoints.length === 0) {
            return null;
        }
        const externals = ['electron', 'electron/renderer', 'electron/common', 'events', 'timers', 'url'];
        const entry = {};
        const baseConfig = this.buildRendererBaseConfig(target);
        const rendererConfig = await this.resolveConfig(((_a = entryPoints[0].preload) === null || _a === void 0 ? void 0 : _a.config) || this.pluginConfig.renderer.config);
        for (const entryPoint of entryPoints) {
            entry[entryPoint.name] = (entryPoint.prefixedEntries || []).concat([entryPoint.preload.js]);
        }
        const config = {
            target: rendererTargetToWebpackTarget(target),
            entry,
            output: {
                path: path_1.default.resolve(this.webpackDir, 'renderer'),
                filename: '[name]/preload.js',
                globalObject: 'self',
                ...(this.isProd ? {} : { publicPath: '/' }),
            },
            plugins: target === RendererTarget.ElectronPreload ? [] : [new webpack_1.default.ExternalsPlugin('commonjs2', externals)],
        };
        return (0, webpack_merge_1.merge)(baseConfig, rendererConfig || {}, config);
    }
    async buildRendererConfigs(entryPoints, target) {
        if (entryPoints.length === 0) {
            return [];
        }
        const rendererConfigs = [];
        if (target === RendererTarget.Web || target === RendererTarget.ElectronRenderer) {
            rendererConfigs.push(this.buildRendererConfigForWebOrRendererTarget(entryPoints, target));
            return rendererConfigs;
        }
        else if (target === RendererTarget.ElectronPreload || target === RendererTarget.SandboxedPreload) {
            if (!(0, rendererTypeUtils_1.isPreloadOnlyEntries)(entryPoints)) {
                throw new Error('Invalid renderer entry point detected.');
            }
            const entryPointsWithPreloadConfig = [], entryPointsWithoutPreloadConfig = [];
            entryPoints.forEach((entryPoint) => (entryPoint.preload.config ? entryPointsWithPreloadConfig : entryPointsWithoutPreloadConfig).push(entryPoint));
            rendererConfigs.push(this.buildRendererConfigForPreloadOrSandboxedPreloadTarget(entryPointsWithoutPreloadConfig, target));
            entryPointsWithPreloadConfig.forEach((entryPoint) => {
                rendererConfigs.push(this.buildRendererConfigForPreloadOrSandboxedPreloadTarget([entryPoint], target));
            });
            return rendererConfigs;
        }
        else {
            throw new Error('Invalid renderer entry point detected.');
        }
    }
}
exports.default = WebpackConfigGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2VicGFja0NvbmZpZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJwYWNrQ29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0RBQXdCO0FBRXhCLGtEQUEwQjtBQUMxQiw4RUFBb0Q7QUFDcEQsc0RBQXdFO0FBQ3hFLGlEQUFzRDtBQUd0RCxxRkFBNkQ7QUFDN0QseUVBQWlEO0FBQ2pELGdFQUFvSTtBQUtwSSxNQUFNLENBQUMsR0FBRyxJQUFBLGVBQUssRUFBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBTy9ELElBQUssY0FLSjtBQUxELFdBQUssY0FBYztJQUNqQixpREFBRyxDQUFBO0lBQ0gsMkVBQWdCLENBQUE7SUFDaEIseUVBQWUsQ0FBQTtJQUNmLDJFQUFnQixDQUFBO0FBQ2xCLENBQUMsRUFMSSxjQUFjLEtBQWQsY0FBYyxRQUtsQjtBQUVELElBQUssYUFJSjtBQUpELFdBQUssYUFBYTtJQUNoQiw0QkFBVyxDQUFBO0lBQ1gscURBQW9DLENBQUE7SUFDcEMsdURBQXNDLENBQUE7QUFDeEMsQ0FBQyxFQUpJLGFBQWEsS0FBYixhQUFhLFFBSWpCO0FBRUQsU0FBUyxTQUFTLENBQUksSUFBYztJQUNsQyxPQUFPLElBQUksS0FBSyxJQUFJLENBQUM7QUFDdkIsQ0FBQztBQUVELFNBQVMsNkJBQTZCLENBQUMsTUFBc0I7SUFDM0QsUUFBUSxNQUFNLEVBQUU7UUFDZCxLQUFLLGNBQWMsQ0FBQyxHQUFHLENBQUM7UUFDeEIsS0FBSyxjQUFjLENBQUMsZ0JBQWdCO1lBQ2xDLE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQztRQUMzQixLQUFLLGNBQWMsQ0FBQyxlQUFlO1lBQ2pDLE9BQU8sYUFBYSxDQUFDLGVBQWUsQ0FBQztRQUN2QyxLQUFLLGNBQWMsQ0FBQyxnQkFBZ0I7WUFDbEMsT0FBTyxhQUFhLENBQUMsZ0JBQWdCLENBQUM7S0FDekM7QUFDSCxDQUFDO0FBRUQsTUFBcUIsc0JBQXNCO0lBV3pDLFlBQVks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